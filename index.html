<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin - Rekomendasiku</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:20px;background:#f6f7fb}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06);max-width:900px;margin:10px auto}
    h2{margin:0 0 12px 0}
    form > *{display:block;width:100%;margin:8px 0}
    input[type=text], input[type=number], textarea, select{padding:10px;border:1px solid #ddd;border-radius:8px}
    button{padding:10px 14px;border-radius:8px;border:0;background:#1a73e8;color:#fff;cursor:pointer}
    .row{display:flex;gap:12px}
    .col{flex:1}
    #log{font-size:13px;color:#444;margin-top:8px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="card">
    <h2>Tambah Kategori</h2>
    <form id="formKategori">
      <input id="kategoriName" type="text" placeholder="Nama kategori..." required />
      <button type="submit">Tambah Kategori</button>
    </form>

    <h3 style="margin-top:18px">Daftar Kategori (live)</h3>
    <ul id="kategoriList"></ul>
  </div>

  <div class="card">
    <h2>Tambah Produk</h2>
    <form id="formProduk">
      <input id="productName" type="text" placeholder="Nama produk" required />
      <div class="row">
        <input id="productPrice" type="number" placeholder="Harga" class="col" required />
        <select id="productCategory" class="col" required>
          <option value="">Pilih kategori...</option>
        </select>
      </div>
      <textarea id="productDesc" placeholder="Deskripsi produk" required></textarea>
      <input id="productTags" type="text" placeholder="Tags (pisahkan pakai koma) e.g. sepatu,olahraga" />
      <input id="productShopee" type="text" placeholder="Link Shopee (opsional)" />
      <input id="productImage" type="file" accept="image/*" />
      <div style="display:flex;gap:10px;align-items:center">
        <button id="btnAddProduct" type="submit">Tambah Produk</button>
        <button id="btnRefresh" type="button" style="background:#6c757d">Refresh list</button>
      </div>
    </form>

    <h3 style="margin-top:18px">Daftar Produk (live)</h3>
    <div id="productList"></div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Script admin (pisah file atau bisa tempel di bawah) --><script>
// === GANTI SESUAI PUNYA KAMU ===
const SUPABASE_URL = "https://deqtolfjenzmskfiocxl.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlcXRvbGZqZW56bXNrZmlvY3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODYxNzUsImV4cCI6MjA4MDE2MjE3NX0.qJQQlUEKqFrhUAVvqoQWQngm6BCWzv3FuteLOCM4yOg";
const BUCKET_NAME = "Product-image";

// Inisialisasi Supabase
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Ambil elemen form & input
const formKategori = document.getElementById("formKategori");
const kategoriName = document.getElementById("kategoriName");
const result = document.getElementById("result");
const kategoriList = document.getElementById("kategoriList");
const productCategory = document.getElementById("productCategory");
const productName = document.getElementById("productName");
const productPrice = document.getElementById("productPrice");
const productDesc = document.getElementById("productDesc");
const productTags = document.getElementById("productTags");
const productShopee = document.getElementById("productShopee");
const productImage = document.getElementById("productImage");
function escapeHtml(text) {
  let map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}
// Event submit
formKategori.addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = kategoriName.value.trim();
  if (!name) return alert("Isi nama kategori!");

  const editId = formKategori.dataset.editId; // cek mode edit
//fungsi edit
if (editId) {
  const { error } = await client
    .from("Categories")
    .update({ name })
    .eq("id", editId);

  if (error) {
    console.error("Update error:", error);
    return alert("Gagal mengupdate kategori");
  }

  alert("Kategori berhasil diupdate!");
  kategoriName.value = "";
  delete formKategori.dataset.editId;
  loadCategories();
  return;
}

  // INSERT
  const { data, error } = await client
    .from("Categories")   // ‚Üê Sesuaikan huruf besar & kecil
    .insert([{ name }]);

  if (error) {
    console.error("Error insert kategori:", error);
    return alert("Gagal menambah kategori");
  }

  kategoriName.value = "";
  await loadCategories();
  alert("Kategori tersimpan");
});
    async function loadCategories() {
  const { data, error } = await client
    .from("Categories")
    .select("*")
    .order("id", { ascending: true });

  if (error) {
    console.error("Error load categories:", error);
    kategoriList.innerHTML = "<li>Error load categories</li>";
    return;
  }

  kategoriList.innerHTML = data.map(c => `
    <li style="margin-bottom:6px;">
      ${escapeHtml(c.name)}
      <button onclick="editKategori(${c.id}, '${escapeHtml(c.name)}')"
        style="margin-left:10px;padding:3px 6px;background:#007bff;color:white;border:none;border-radius:4px;">
        Edit
      </button>
      <button onclick="deleteKategori(${c.id})"
        style="padding:3px 6px;background:#dc3545;color:white;border:none;border-radius:4px;">
        Hapus
      </button>
    </li>
  `).join("");


  // Update dropdown produk
  productCategory.innerHTML =
    `<option value="">Pilih kategori...</option>` +
    data.map(c =>
      `<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`
    ).join("");
}
//hapus categori
async function deleteKategori(id) {
  if (!confirm("Hapus kategori ini?")) return;

  const { error } = await client
    .from("Categories")
    .delete()
    .eq("id", id);

  if (error) {
    console.error("Delete error:", error);
    alert("Gagal menghapus kategori");
    return;
  }

  alert("Kategori dihapus");
  loadCategories();
}
//fungsi edit
function editKategori(id, name) {
  kategoriName.value = name;
  formKategori.dataset.editId = id;
  alert("Mode edit kategori aktif. Silakan ubah lalu klik Simpan.");
}

// =========== Upload image ===========
async function uploadImageToStorage(file) {
  if (!file) return null;

  const ext = file.name.split(".").pop();
  const fileName = `${Date.now()}.${ext}`;

  const { error } = await client.storage
    .from(BUCKET_NAME)
    .upload(fileName, file);

  if (error) {
    console.error("Upload error:", error);
    return null;
  }

  const { data } = client.storage.from(BUCKET_NAME).getPublicUrl(fileName);
  return data.publicUrl;
}
// --- SIMPAN PRODUK KE DATABASE ---
document.getElementById("formProduk").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("productName").value;
    const price = document.getElementById("productPrice").value;
    const desc = document.getElementById("productDesc").value;
    const tags = document.getElementById("productTags").value.split(" ").map(t => t.trim().toLowerCase());
    const category = document.getElementById("productCategory").value;
    const shopee_link = document.getElementById("productShopee").value;

 let Img_url = null;
  const file = productImage.files[0];
  if (file) {
    Img_url = await uploadImageToStorage(file);
    if (!Img_url) return alert("Gagal upload gambar");
  }
  
  // --- UPDATE MODE ---
    if (editingProductId) {
        const { error } = await client
            .from("Products")
            .update(payload)
            .eq("id", editingProductId);

        if (error) {
            console.error(error);
            return alert("Update gagal");
        }

        alert("Produk berhasil diupdate!");

        editingProductId = null;
        submitProductBtn.textContent = "Tambah Produk";
        productForm.reset();
        loadProducts();
        return;
    }
    // Simpan ke table Supabase
    const { error } = await client.from("Products").insert([{
    name,
    price,
    desc,
    category,
    tags,
    shopee_link,
    Img_url
}]);

    if (error) {
    console.error("Insert error details:", JSON.stringify(error, null, 2));
    alert("Gagal menyimpan produk! Cek console untuk detail.");
    return;
}

    alert("Produk berhasil ditambahkan!");
    e.target.reset();
    loadProducts(); // refresh daftar
});

// --- LOAD PRODUK UNTUK DITAMPILKAN DI ADMIN ---
async function loadProducts() {
    const { data: products, error } = await client
        .from("Products")
        .select("*")
        .order("created_at", { ascending: false });

    if (error) {
        console.error(error);
        return alert("Gagal memuat produk");
    }

    const grid = document.getElementById("productList");
    grid.innerHTML = "";

    products.forEach(p => {
        grid.innerHTML += `
        <div class="product-card">
            <img src="${p.Img_url}">
            <p><b>${p.name}</b></p>
            <p>Rp ${p.price}</p>
            <small>Kategori: ${p.category}</small>
            <p>${p.desc}</p>

            <div>
                ${(Array.isArray(p.tags) ? p.tags : (p.tags ? p.tags.split(" ") : []))
                .map(t => `<span class="tag">${t}</span>`).join(" ")}
            </div>

            <a href="${p.shopee_link}" target="_blank">Shopee</a>

            <div style="margin-top:8px; display:flex; gap:8px;">
                <button onclick="editProduct(${p.id})" 
                    style="padding:6px 10px; background:#007bff; color:white; border:none; border-radius:6px;">
                    Edit
                </button>

                <button onclick="deleteProduct(${p.id})" 
                    style="padding:6px 10px; background:#dc3545; color:white; border:none; border-radius:6px;">
                    Hapus
                </button>
            </div>
        </div>`;
    });
}
async function deleteProduct(id) {
    if (!confirm("Yakin ingin menghapus produk ini?")) return;

    const { error } = await client
        .from("Products")
        .delete()
        .eq("id", id);

    if (error) {
        console.error(error);
        return alert("Gagal menghapus produk");
    }

    alert("Produk berhasil dihapus!");
    loadProducts(); // refresh daftar
}
let editingProductId = null;
async function editProduct(id) {
    const { data, error } = await client
        .from("Products")
        .select("*")
        .eq("id", id)
        .single();

    if (error) {
        console.error(error);
        return alert("Gagal mengambil data produk");
    }

    // Isi form
    productName.value = data.name;
    productPrice.value = data.price;
    productCategory.value = data.category;
    productDesc.value = data.desc;

    productTags.value = Array.isArray(data.tags)
        ? data.tags.join(", ")
        : data.tags;

    productShopee.value = data.shopee_link;

    editingProductId = id;

  document.getElementById("submitProductBtn").textContent = "Update Produk";

    alert("Mode edit aktif. Silakan ubah data produk.");
}
loadProducts();
loadCategories();
</script>
</body>
</html>
