<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin - Rekomendasiku</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:20px;background:#f6f7fb}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06);max-width:900px;margin:10px auto}
    h2{margin:0 0 12px 0}
    form > *{display:block;width:100%;margin:8px 0}
    input[type=text], input[type=number], textarea, select{padding:10px;border:1px solid #ddd;border-radius:8px}
    button{padding:10px 14px;border-radius:8px;border:0;background:#1a73e8;color:#fff;cursor:pointer}
    .row{display:flex;gap:12px}
    .col{flex:1}
    #log{font-size:13px;color:#444;margin-top:8px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="card">
    <h2>Tambah Kategori</h2>
    <form id="formKategori">
      <input id="kategoriName" type="text" placeholder="Nama kategori..." required />
      <button type="submit">Tambah Kategori</button>
    </form>

    <h3 style="margin-top:18px">Daftar Kategori (live)</h3>
    <ul id="kategoriList"></ul>
  </div>

  <div class="card">
    <h2>Tambah Produk</h2>
    <form id="formProduk">
      <input id="productName" type="text" placeholder="Nama produk" required />
      <div class="row">
        <input id="productPrice" type="number" placeholder="Harga" class="col" required />
        <select id="productCategory" class="col" required>
          <option value="">Pilih kategori...</option>
        </select>
      </div>
      <textarea id="productDesc" placeholder="Deskripsi produk" required></textarea>
      <input id="productTags" type="text" placeholder="Tags (pisahkan pakai koma) e.g. sepatu,olahraga" />
      <input id="productShopee" type="text" placeholder="Link Shopee (opsional)" />
      <input id="productImage" type="file" accept="image/*" />
      <div style="display:flex;gap:10px;align-items:center">
        <button id="btnAddProduct" type="submit">Tambah Produk</button>
        <button id="btnRefresh" type="button" style="background:#6c757d">Refresh list</button>
      </div>
    </form>

    <h3 style="margin-top:18px">Daftar Produk (live)</h3>
    <div id="productList"></div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Script admin (pisah file atau bisa tempel di bawah) --><script>
// === GANTI SESUAI PUNYA KAMU ===
const SUPABASE_URL = "https://deqtolfjenzmskfiocxl.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlcXRvbGZqZW56bXNrZmlvY3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODYxNzUsImV4cCI6MjA4MDE2MjE3NX0.qJQQlUEKqFrhUAVvqoQWQngm6BCWzv3FuteLOCM4yOg";

// Inisialisasi Supabase
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Ambil elemen form & input
const formKategori = document.getElementById("formKategori");
const kategoriName = document.getElementById("kategoriName");
const result = document.getElementById("result");
const kategoriList = document.getElementById("kategoriList");
const productCategory = document.getElementById("productCategory");
const formProduk = document.getElementById("formProduk");
const productName = document.getElementById("productName");
const productPrice = document.getElementById("productPrice");
const productCategory = document.getElementById("productCategory");
const productDesc = document.getElementById("productDesc");
const productTags = document.getElementById("productTags");
const productShopee = document.getElementById("productShopee");
const productImage = document.getElementById("productImage");
function escapeHtml(text) {
  let map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}
// Event submit
formKategori.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = kategoriName.value.trim();
  if (!name) return alert("Isi nama kategori!");

  // INSERT
  const { data, error } = await client
    .from("Categories")   // ← Sesuaikan huruf besar & kecil
    .insert([{ name }]);

  if (error) {
    console.error(error);
    result.textContent = "❌ ERROR insert: " + error.message;
    return;
  }

  kategoriName.value = "";
  await loadCategories();
  alert("Kategori tersimpan");
});
    async function loadCategories() {
  const { data, error } = await client
    .from("Categories")
    .select("*")
    .order("id", { ascending: true });

  if (error) {
    console.error("Error load categories:", error);
    kategoriList.innerHTML = "<li>Error load categories</li>";
    return;
  }

  kategoriList.innerHTML = data
    .map(c => `<li>${escapeHtml(c.name)}</li>`)
    .join("");

  // Update dropdown produk
  productCategory.innerHTML =
    `<option value="">Pilih kategori...</option>` +
    data.map(c =>
      `<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`
    ).join("");
}

 // fungsi uppload image
async function uploadImageToStorage(file) {
  if (!file) return null;

  const ext = file.name.split(".").pop();
  const fileName = `${Date.now()}.${ext}`;

  const { error } = await client.storage
    .from(BUCKET_NAME)
    .upload(fileName, file);

  if (error) {
    console.error("Upload error:", error);
    return null;
  }

  const { data } = client.storage.from(BUCKET_NAME).getPublicUrl(fileName);
  return data.publicUrl;
}

    // =========== Insert produk ===========
formProduk.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = productName.value.trim();
  const price = productPrice.value;
  const desc = productDesc.value.trim();
  const category = productCategory.value;
  const tags = productTags.value.split(",").map(t => t.trim()).filter(Boolean);
  const shopee = productShopee.value.trim();

  if (!name || !price || !category) {
    return alert("Nama, harga, dan kategori wajib diisi");
  }

  let imgUrl = null;
  const file = productImage.files[0];
  if (file) {
    imgUrl = await uploadImageToStorage(file);
    if (!imgUrl) return alert("Gagal upload gambar");
  }

  const payload = {
    name, category, desc, tags, img_url,
    shopee_link: shopee,
    created_at: new Date()
  };

  const { error } = await client
    .from("Products")
    .insert([payload]);

  if (error) {
    console.error("Error insert Product:", error);
    return alert("Gagal menyimpan produk");
  }

  formProduk.reset();
  await loadProducts();
  alert("Produk tersimpan");
});
// =========== Load products ===========
</script>
</body>
</html>
